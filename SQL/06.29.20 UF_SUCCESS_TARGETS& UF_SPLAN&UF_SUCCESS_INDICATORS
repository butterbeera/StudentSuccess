CREATE TABLE UF_SUCCESS_TARGET as (SELECT
    PERSON_SID, 
    SUM(CASE WHEN "CUR_GPA" <= 2.2 AND "ACADEMIC_LOAD" <> 'N' AND UNT_TAKEN_GPA<> 0 THEN 1 ELSE 0 END) AS "LOW_TERM_GPA_IND",        
    SUM(CASE WHEN "ACADEMIC_LOAD" in ('H','L','T') THEN 1 ELSE 0 END) AS "PARTTIME_TERM_IND", 
    SUM(CASE WHEN "ACADEMIC_LOAD" = 'N' THEN 1 ELSE 0 END) AS "NOT_REG_TERM_IND", 
    SUM(CASE WHEN "ACADEMIC_LOAD" <> 'N' AND UNT_TAKEN_GPA=0  THEN 1 ELSE 0 END) AS "WITHDRWL_TERM_IND",
    SUM(CASE WHEN "ACADEMIC_LOAD" = 'F' THEN 1 ELSE 0 END) AS "FULLTIME_TERM_IND",
    SUM(CASE WHEN "UNT_TAKEN_GPA" > 12 THEN 1 ELSE 0 END) AS "OVR_12HR_TERM_IND"
FROM UF_B_STDNT_TERM where ACAD_CAREER ='UGRD'
GROUP BY PERSON_SID)

CREATE TABLE UF_SPLAN AS (Select                 
          SP.ACAD_CAR_SID  SPLAN_ACAD_CAREER_SID,
          SP.ACAD_PLAN_SID SPLAN_ACAD_PLAN_SID, 
          SP.ACAD_SPLAN_SID SPLAN_ACAD_SUB_PLAN_SID
FROM UF_D_ACAD_SPLAN SP where     
	 SP.EFFDT = (SELECT MAX(D_ED.EFFDT) FROM UF_D_ACAD_SPLAN D_ED 
		where (SP.ACAD_CAR_SID = D_ED.ACAD_CAR_SID AND D_ED.EFFDT <= SYSDATE))
              )

CREATE TABLE UF_SUCCESS_INDICATORS as (SELECT         
         A.PERSON_SID ,
         A.INSTITUTION_SID,
         A.ACAD_CAR_SID ADMIT_ACAD_CAREER,
         A.STDNT_CAR_NBR,
         A.ADMIT_TERM_SID,
         A.ACAD_PROG_SID ADMIT_ACAD_PROG,
         A.ADM_APPL_NBR,
         A.EFFDT_SID,
         A.END_EFFDT_SID,
         A.ACAD_PROG,
         A.PROG_STATUS_SID,
         A.PROG_REASON_SID,
         A.PROG_COMPLETION_TERM_SID,
         A.ACAD_PLAN_SID,
         A.ACAD_SPLAN_SID,
         A.EXP_GRAD_TERM_TERM_SID,
         A.DEGREE_SID,
         F.TOT_CUMULATIVE, 
         F.STRM MOST_RECENT_REG_TERM,
         A.ACAD_ORG_SID,        
         IND.LOW_TERM_GPA_IND,
         IND.PARTTIME_TERM_IND,
         IND.NOT_REG_TERM_IND,
         IND.WITHDRWL_TERM_IND,
         IND.FULLTIME_TERM_IND,
         IND.OVR_12HR_TERM_IND,       
         (IND.LOW_TERM_GPA_IND + IND.PARTTIME_TERM_IND + IND.NOT_REG_TERM_IND + IND.WITHDRWL_TERM_IND) AS INDICATOR_TOTAL ,     
         CASE WHEN (A.DEGR_CHKOUT_STAT_SID=5) THEN (0)     															 
	 ELSE (IND.LOW_TERM_GPA_IND + IND.PARTTIME_TERM_IND + IND.NOT_REG_TERM_IND + IND.WITHDRWL_TERM_IND)		
         END HAS_INDICATOR_FLAG,          											  
         RANK () OVER 
	 (PARTITION BY A.PERSON_SID 
		ORDER BY 
         CASE WHEN A.ACAD_CAREER = F.ACAD_CAREER AND A.STDNT_CAR_NBR=F.STDNT_CAR_NBR THEN 1  
                   ELSE 9 
         END, 
	 F.STDNT_CAR_NBR,A.PLAN_SEQUENCE, A.ACAD_PLAN_SID) 
	 AS PRIMARY_PLAN_ORDER
																	    							
FROM UF_F_CPPS A  
LEFT OUTER JOIN UF_SUCCESS_TARGET IND
	ON IND.PERSON_SID=A.PERSON_SID
 
INNER JOIN UF_B_STDNT_TERM F 
	ON A.PERSON_SID = F.PERSON_SID 
		AND A.INSTITUTION_SID = F.INSTITUTION_SID 
			AND A.ACAD_CAREER = F.ACAD_CAREER
 
WHERE
    (
	A.EFFDT_SID = (SELECT MAX(B_ED.EFFDT_SID) 
	FROM UF_F_CPPS B_ED 
		WHERE A.PERSON_SID = B_ED.PERSON_SID                
                  AND A.ACAD_CAREER = B_ED.ACAD_CAREER
     		  AND A.STDNT_CAR_NBR = B_ED.STDNT_CAR_NBR
     		 ) AND
	F.STRM = (SELECT MAX( G.STRM) 
	FROM UF_B_STDNT_TERM G 
		WHERE G.PERSON_SID = F.PERSON_SID 
                  AND G.INSTITUTION_SID = F.INSTITUTION_SID
                  AND A.ACAD_CAREER = G.ACAD_CAREER)    
))
